<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>0DTE Strategy Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js" crossorigin></script>
    <script>
      (function () {
        function loadScript(src) {
          return new Promise((resolve, reject) => {
            if (document.querySelector(`script[data-dynamic-src="${src}"]`)) {
              resolve();
              return;
            }
            const script = document.createElement("script");
            script.src = src;
            script.async = true;
            script.dataset.dynamicSrc = src;
            script.onload = () => resolve();
            script.onerror = () => reject(new Error(`Failed to load script ${src}`));
            document.head.appendChild(script);
          });
        }

        const cdnSources = [
          "https://unpkg.com/recharts@2.10.3/umd/Recharts.min.js",
          "https://cdn.jsdelivr.net/npm/recharts@2.10.3/umd/Recharts.min.js",
          "https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js",
        ];

        window.__loadRechartsPromise = (async () => {
          if (window.Recharts) {
            return window.Recharts;
          }
          for (const src of cdnSources) {
            try {
              await loadScript(src);
              if (window.Recharts) {
                return window.Recharts;
              }
            } catch (error) {
              console.warn(error.message);
            }
          }
          throw new Error("Unable to load Recharts from any CDN");
        })();
      })();
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-gray-900 text-gray-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
      (async function init() {
        if (!window.React || !window.ReactDOM) {
          console.error("React or ReactDOM failed to load.");
          return;
        }

        try {
          await window.__loadRechartsPromise;
        } catch (error) {
          console.error(error.message);
        }

        if (!window.Recharts) {
          const fallbackRoot = document.getElementById("root");
          if (fallbackRoot) {
            fallbackRoot.innerHTML = `
              <div class="min-h-screen flex items-center justify-center bg-gray-900 text-red-300">
                <div class="bg-gray-800 border border-red-500 rounded-lg p-6 max-w-lg text-center">
                  <h2 class="text-2xl font-semibold mb-3">Failed to load charting library.</h2>
                  <p>Please ensure you have an internet connection and refresh the page.</p>
                </div>
              </div>
            `;
          }
          return;
        }

        const { useState, useMemo, useEffect, useRef } = React;
        const {
          LineChart,
          Line,
          XAxis,
          YAxis,
          CartesianGrid,
          Tooltip,
          Legend,
          ResponsiveContainer,
          BarChart,
          Bar,
          PieChart,
          Pie,
          Cell,
        } = window.Recharts;

      const iconFactory = (emoji) => ({ size = 24 }) => (
        <span
          aria-hidden="true"
          style={{ fontSize: size, lineHeight: 1 }}
          className="inline-flex items-center justify-center"
        >
          {emoji}
        </span>
      );

      const Icons = {
        DollarSign: iconFactory("ðŸ’µ"),
        Upload: iconFactory("ðŸ“¤"),
        FileText: iconFactory("ðŸ“„"),
        TrendingUp: iconFactory("ðŸ“ˆ"),
        TrendingDown: iconFactory("ðŸ“‰"),
        CheckCircle: iconFactory("âœ…"),
        AlertTriangle: iconFactory("âš ï¸"),
        Filter: iconFactory("ðŸ§°"),
        Shield: iconFactory("ðŸ›¡ï¸"),
        Target: iconFactory("ðŸŽ¯"),
        Layers: iconFactory("ðŸ—‚ï¸"),
        Clock: iconFactory("ðŸ•’"),
        CalendarDays: iconFactory("ðŸ“…"),
        Timer: iconFactory("â±ï¸"),
        PlusCircle: iconFactory("âž•"),
        MinusCircle: iconFactory("âž–"),
        DivideCircle: iconFactory("âž—"),
        BarChartHorizontal: iconFactory("ðŸ“Š"),
        Waves: iconFactory("ðŸŒŠ"),
        Scaling: iconFactory("ðŸ“"),
      };

      const calculateMetrics = (trades, isNormalized) => {
        if (!trades || trades.length === 0) {
          return {
            totalPL: 0,
            totalTrades: 0,
            winRate: 0,
            avgPL: 0,
            var95: 0,
            cvar95: 0,
            avgWin: 0,
            avgLoss: 0,
            profitFactor: 0,
            profitCapturePct: 0,
          };
        }

        const processedTrades = trades.map((t) => ({
          ...t,
          pl: isNormalized ? t.pl / (t.contracts || 1) : t.pl,
        }));

        const pls = processedTrades.map((t) => t.pl).sort((a, b) => a - b);
        const totalTrades = pls.length;
        const totalPL = pls.reduce((acc, pl) => acc + pl, 0);

        const winningTradesData = pls.filter((pl) => pl > 0);
        const losingTradesData = pls.filter((pl) => pl < 0);

        const totalWinnings = winningTradesData.reduce((acc, pl) => acc + pl, 0);
        const totalLosses = Math.abs(losingTradesData.reduce((acc, pl) => acc + pl, 0));

        const winRate = (winningTradesData.length / totalTrades) * 100;
        const avgPL = totalPL / totalTrades;

        const avgWin = winningTradesData.length ? totalWinnings / winningTradesData.length : 0;
        const avgLoss = losingTradesData.length ? totalLosses / losingTradesData.length : 0;
        const profitFactor = totalLosses === 0 ? totalWinnings : totalWinnings / totalLosses;

        const varIndex = Math.floor(totalTrades * 0.05);
        const var95 = pls[varIndex] || 0;
        const lossesBeyondVar = pls.slice(0, varIndex + 1);
        const cvar95 =
          lossesBeyondVar.length === 0
            ? 0
            : lossesBeyondVar.reduce((acc, pl) => acc + pl, 0) / lossesBeyondVar.length;

        const stoTrades = trades.filter(
          (t) => t.legType === "Core (STO)" && typeof t.initialPremium === "number" && t.initialPremium > 0
        );
        let profitCapturePct = 0;

        if (stoTrades.length > 0) {
          const totalCapturedPL = stoTrades.reduce((acc, t) => acc + t.pl, 0);
          const totalMaxPremium = stoTrades.reduce(
            (acc, t) => acc + (t.initialPremium || 0) * (t.contracts || 0) * 100,
            0
          );

          if (totalMaxPremium > 0) {
            profitCapturePct = (totalCapturedPL / totalMaxPremium) * 100;
          }
        }

        return {
          totalPL,
          totalTrades,
          winRate,
          avgPL,
          var95,
          cvar95,
          avgWin,
          avgLoss: -avgLoss,
          profitFactor,
          profitCapturePct,
        };
      };

      const prepareChartData = (trades, isNormalized) => {
        const processedTrades = trades.map((t) => ({
          ...t,
          pl: isNormalized ? t.pl / (t.contracts || 1) : t.pl,
        }));

        const sortedTrades = [...processedTrades].sort((a, b) => a.dateClosed - b.dateClosed);

        let cumulativePL = 0;
        const equityCurve = sortedTrades.map((trade, index) => {
          cumulativePL += trade.pl;
          return {
            name: trade.dateClosed.toLocaleDateString(),
            tradeNumber: index + 1,
            "Cumulative P/L": cumulativePL,
          };
        });

        if (trades.length === 0) {
          return {
            equityCurve: [],
            plDistribution: [],
            reasonData: [],
            hourlyPLData: [],
            dayOfWeekPLData: [],
            durationPLData: [],
            underlyingMovePLData: [],
          };
        }

        const pls = processedTrades.map((t) => t.pl);
        const minPL = Math.min(...pls);
        const maxPL = Math.max(...pls);
        const numBins = 20;
        const binSize = maxPL - minPL === 0 ? 1 : (maxPL - minPL) / numBins;

        const bins = Array(numBins)
          .fill(0)
          .map((_, i) => {
            const binStart = minPL + i * binSize;
            const binEnd = binStart + binSize;
            return {
              range: `${binStart.toFixed(0)} to ${binEnd.toFixed(0)}`,
              count: 0,
              binStart,
              binEnd,
            };
          });

        pls.forEach((pl) => {
          let foundBin = false;
          for (const bin of bins) {
            if (pl >= bin.binStart && pl < bin.binEnd) {
              bin.count += 1;
              foundBin = true;
              break;
            }
          }
          if (!foundBin || pl === maxPL) {
            bins[bins.length - 1].count += 1;
          }
        });

        const reasonMap = new Map();
        processedTrades.forEach((trade) => {
          const reason = trade.reason || "Unknown";
          const current = reasonMap.get(reason) || { totalPL: 0, count: 0 };
          reasonMap.set(reason, {
            totalPL: current.totalPL + trade.pl,
            count: current.count + 1,
          });
        });

        const reasonData = Array.from(reasonMap.entries()).map(([name, data]) => {
          const val = Number.isFinite(data.totalPL) ? data.totalPL : 0;
          return {
            name,
            value: val,                // signed P/L for tooltips and labels
            valueAbs: Math.abs(val),   // size for the pie slice
            count: data.count,
            sign: Math.sign(val) || 0, // for coloring
          };
        });

        const hourlyPLData = Array(24)
          .fill(null)
          .map((_, i) => ({ hour: i, "Total P/L": 0, count: 0 }));

        const formatHour = (h) => {
          if (h === 0) return "12 AM";
          if (h < 12) return `${h} AM`;
          if (h === 12) return "12 PM";
          return `${h - 12} PM`;
        };

        processedTrades.forEach((trade) => {
          const hour = trade.openHour;
          if (hour >= 0 && hour <= 23) {
            hourlyPLData[hour]["Total P/L"] += trade.pl;
            hourlyPLData[hour].count += 1;
          }
        });

        const formattedHourlyData = hourlyPLData
          .map((d) => ({ ...d, hourLabel: formatHour(d.hour) }))
          .filter((d) => d.count > 0);

        const dayLabels = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const dayOfWeekPLData = dayLabels.map((day) => ({ day, "Total P/L": 0, count: 0 }));

        processedTrades.forEach((trade) => {
          const dayIndex = trade.dayOfWeek;
          if (dayIndex >= 0 && dayIndex < 7) {
            dayOfWeekPLData[dayIndex]["Total P/L"] += trade.pl;
            dayOfWeekPLData[dayIndex].count += 1;
          }
        });

        const durationBins = [
          { label: "0-30m", min: 0, max: 30, "Total P/L": 0, count: 0 },
          { label: "30-60m", min: 30, max: 60, "Total P/L": 0, count: 0 },
          { label: "1-2h", min: 60, max: 120, "Total P/L": 0, count: 0 },
          { label: "2-4h", min: 120, max: 240, "Total P/L": 0, count: 0 },
          { label: "4-6h", min: 240, max: 360, "Total P/L": 0, count: 0 },
          { label: "6h+", min: 360, max: Infinity, "Total P/L": 0, count: 0 },
        ];

        processedTrades.forEach((trade) => {
          const duration = trade.durationMinutes;
          for (const bin of durationBins) {
            if (duration >= bin.min && duration < bin.max) {
              bin["Total P/L"] += trade.pl;
              bin.count += 1;
              break;
            }
          }
        });

        const moveBins = [
          { label: "< -1%", min: -Infinity, max: -1, "Total P/L": 0, count: 0 },
          { label: "-1% to -0.5%", min: -1, max: -0.5, "Total P/L": 0, count: 0 },
          { label: "-0.5% to 0%", min: -0.5, max: 0, "Total P/L": 0, count: 0 },
          { label: "0% to 0.5%", min: 0, max: 0.5, "Total P/L": 0, count: 0 },
          { label: "0.5% to 1%", min: 0.5, max: 1, "Total P/L": 0, count: 0 },
          { label: "> 1%", min: 1, max: Infinity, "Total P/L": 0, count: 0 },
        ];

        processedTrades.forEach((trade) => {
          const movePct = trade.underlyingMovePct;
          if (typeof movePct !== "number") return;
          for (const bin of moveBins) {
            if (movePct >= bin.min && movePct < bin.max) {
              bin["Total P/L"] += trade.pl;
              bin.count += 1;
              break;
            }
          }
        });

        return {
          equityCurve,
          plDistribution: bins,
          reasonData,
          hourlyPLData: formattedHourlyData,
          dayOfWeekPLData: dayOfWeekPLData.filter((d) => d.count > 0),
          durationPLData: durationBins.filter((d) => d.count > 0),
          underlyingMovePLData: moveBins.filter((d) => d.count > 0),
        };
      };

      const KpiCard = ({ title, value, icon, format = "number", unit = "" }) => {
        const IconComponent = icon || Icons.DollarSign;

        let displayValue;
        if (typeof value !== "number" || Number.isNaN(value)) {
          displayValue = "--";
        } else if (format === "currency") {
          const minDigits = Math.abs(value) > 0 && Math.abs(value) < 1 ? 4 : 2;
          displayValue = value.toLocaleString("en-US", {
            style: "currency",
            currency: "USD",
            minimumFractionDigits: minDigits,
            maximumFractionDigits: 4,
          });
        } else if (format === "percent") {
          displayValue = `${value.toFixed(2)}%`;
        } else if (format === "decimal") {
          displayValue = value.toFixed(2);
        } else {
          displayValue = value.toLocaleString("en-US", { maximumFractionDigits: 0 });
        }

        const isNegative = typeof value === "number" && value < 0 && title !== "Avg. Loss";
        const isPositive = typeof value === "number" && value > 0 && title !== "Avg. Loss";

        let colorClass = "text-white";
        if (isNegative) colorClass = "text-red-400";
        if (isPositive) colorClass = "text-green-400";
        if (title === "Avg. Loss") colorClass = "text-red-400";
        if (title === "Avg. Win") colorClass = "text-green-400";
        if (title === "Profit Factor" && typeof value === "number") {
          colorClass = value >= 1 ? "text-green-400" : "text-red-400";
        }
        if (title === "Profit Capture %" && typeof value === "number") {
          colorClass = value >= 25 ? "text-green-400" : "text-yellow-400";
        }

        return (
          <div className="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
            <div className="p-3 rounded-full bg-gray-700 text-blue-300">
              <IconComponent size={24} />
            </div>
            <div>
              <div className="text-sm font-medium text-gray-400 uppercase tracking-wider">{title}</div>
              <div className={`text-3xl font-bold ${colorClass}`}>
                {displayValue}
                {unit && <span className="text-lg ml-1">{unit}</span>}
              </div>
            </div>
          </div>
        );
      };

      const FileUploader = ({ onFileUpload, fileName }) => {
        const inputRef = useRef(null);

        const handleFiles = (files) => {
          if (files && files.length > 0) {
            onFileUpload(files[0]);
          }
        };

        const onDrop = (event) => {
          event.preventDefault();
          event.stopPropagation();
          handleFiles(event.dataTransfer.files);
        };

        const onDragOver = (event) => {
          event.preventDefault();
          event.stopPropagation();
        };

        const onChange = (event) => {
          handleFiles(event.target.files);
        };

        return (
          <div
            className={`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors h-full flex flex-col justify-center ${
              fileName ? "border-green-600 bg-green-900/40" : "border-gray-600 hover:border-gray-500 bg-gray-800"
            }`}
            onDrop={onDrop}
            onDragOver={onDragOver}
            onClick={() => inputRef.current?.click()}
          >
            <input
              ref={inputRef}
              type="file"
              accept=".csv,text/csv"
              className="hidden"
              onChange={onChange}
            />
            {fileName ? (
              <div className="flex flex-col items-center text-green-300 space-y-2">
                <Icons.FileText size={40} />
                <p className="text-xl font-semibold">File Loaded:</p>
                <p className="text-lg">{fileName}</p>
                <p className="text-sm text-gray-300">(Click or drop another file to replace)</p>
              </div>
            ) : (
              <div className="flex flex-col items-center text-gray-400 space-y-2">
                <Icons.Upload size={40} />
                <p className="text-xl font-semibold">Drop your trade log here</p>
                <p className="text-lg text-gray-300">or click to browse</p>
                <p className="text-sm text-gray-400">(.csv files only)</p>
              </div>
            )}
          </div>
        );
      };

      const StrategyFilter = ({ allStrategies, selectedStrategies, onChange }) => {
        const handleChange = (event) => {
          const selectedOptions = Array.from(event.target.selectedOptions, (option) => option.value);
          onChange(selectedOptions);
        };

        return (
          <div className="bg-gray-800 p-4 rounded-lg h-full">
            <label htmlFor="strategy-select" className="block text-sm font-medium text-gray-300 mb-2">
              Filter Strategies
            </label>
            <select
              id="strategy-select"
              multiple
              value={selectedStrategies}
              onChange={handleChange}
              className="w-full h-40 bg-gray-900 border border-gray-700 text-gray-200 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500"
            >
              {allStrategies.map((strategy) => (
                <option key={strategy} value={strategy} className="p-2">
                  {strategy}
                </option>
              ))}
            </select>
            <p className="text-xs text-gray-500 mt-2">Hold Ctrl/Cmd to select multiple.</p>
          </div>
        );
      };

      const LegTypeFilter = ({ selectedValue, onChange }) => {
        const options = [
          { value: "All Trades", label: "All Trades", icon: Icons.Layers },
          { value: "Core (STO)", label: "Core (STO) Only", icon: Icons.Target },
          { value: "Wing (BTO)", label: "Wing (BTO) Only", icon: Icons.Shield },
        ];

        return (
          <div className="bg-gray-800 p-4 rounded-lg h-full">
            <label className="block text-sm font-medium text-gray-300 mb-3">Filter Leg Type</label>
            <div className="space-y-2">
              {options.map((option) => {
                const Icon = option.icon;
                return (
                  <label
                    key={option.value}
                    className="flex items-center space-x-3 p-3 bg-gray-900 rounded-md cursor-pointer hover:bg-gray-700 transition-colors"
                  >
                    <input
                      type="radio"
                      name="legType"
                      value={option.value}
                      checked={selectedValue === option.value}
                      onChange={(event) => onChange(event.target.value)}
                      className="form-radio h-4 w-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500"
                    />
                    <Icon size={20} />
                    <span className="text-gray-200">{option.label}</span>
                  </label>
                );
              })}
            </div>
          </div>
        );
      };

      const NormalizationToggle = ({ isNormalized, onChange }) => {
        return (
          <div className="bg-gray-800 p-4 rounded-lg h-full flex flex-col justify-center">
            <label className="flex items-center justify-between cursor-pointer">
              <div className="flex items-center space-x-3">
                <Icons.Scaling size={20} />
                <span className="text-sm font-medium text-gray-300">Normalize P/L (Per Contract)</span>
              </div>
              <div className="relative">
                <input
                  type="checkbox"
                  className="sr-only"
                  checked={isNormalized}
                  onChange={(event) => onChange(event.target.checked)}
                />
                <div className={`block w-12 h-7 rounded-full ${isNormalized ? "bg-blue-600" : "bg-gray-700"}`}></div>
                <div
                  className={`dot absolute left-1 top-1 bg-white w-5 h-5 rounded-full transition-transform ${
                    isNormalized ? "translate-x-full" : ""
                  }`}
                ></div>
              </div>
            </label>
            <p className="text-xs text-gray-500 mt-2">View all P/L stats relative to a single contract.</p>
          </div>
        );
      };

      const App = () => {
        const [allData, setAllData] = useState([]);
        const [fileName, setFileName] = useState("");
        const [allStrategies, setAllStrategies] = useState([]);
        const [selectedStrategies, setSelectedStrategies] = useState([]);
        const [selectedLegType, setSelectedLegType] = useState("All Trades");
        const [isNormalized, setIsNormalized] = useState(false);
        const [parserReady, setParserReady] = useState(() => Boolean(window.Papa));

        useEffect(() => {
          if (window.Papa) {
            setParserReady(true);
            return undefined;
          }
          const script = document.createElement("script");
          script.src = "https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js";
          script.async = true;
          script.onload = () => setParserReady(true);
          script.onerror = () => console.error("Failed to load PapaParse");
          document.body.appendChild(script);
          return () => {
            document.body.removeChild(script);
          };
        }, []);

        const handleFileUpload = (file) => {
          if (!file) return;
          if (!window.Papa) {
            console.error("PapaParse not available yet.");
            setFileName("Parser not ready. Try again.");
            return;
          }

          setFileName(file.name);
          window.Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              const processedData = results.data
                .map((row) => {
                  const legsStr = row["Legs"] || "";
                  let legType = "Unknown";
                  if (legsStr.includes(" STO ")) legType = "Core (STO)";
                  else if (legsStr.includes(" BTO ")) legType = "Wing (BTO)";

                  const dateOpened = new Date(row["Date Opened"]);
                  const dateClosed = new Date(row["Date Closed"]);

                  const pl = parseFloat(row["P/L"]);
                  const contracts = parseInt(row["No. of Contracts"], 10) || 1;
                  const initialPremium = parseFloat(row["Initial Premium"]);
                  const openingPrice = parseFloat(row["Opening Price"]);
                  const closingPrice = parseFloat(row["Closing Price"]);

                  const durationMinutes = (dateClosed - dateOpened) / (1000 * 60);
                  const dayOfWeek = dateOpened.getDay();
                  let underlyingMovePct = 0;
                  if (typeof openingPrice === "number" && !Number.isNaN(openingPrice) && openingPrice !== 0) {
                    underlyingMovePct = ((closingPrice - openingPrice) / openingPrice) * 100;
                  }

                  return {
                    ...row,
                    pl,
                    dateClosed,
                    dateOpened,
                    openHour: dateOpened.getHours(),
                    reason: row["Reason For Close"],
                    strategy: row["Strategy"],
                    legType,
                    durationMinutes,
                    dayOfWeek,
                    contracts,
                    initialPremium,
                    openingPrice,
                    closingPrice,
                    underlyingMovePct,
                  };
                })
                .filter(
                  (row) =>
                    !Number.isNaN(row.pl) &&
                    row.dateClosed.toString() !== "Invalid Date" &&
                    row.dateOpened.toString() !== "Invalid Date" &&
                    !Number.isNaN(row.contracts)
                );

              const uniqueStrategies = [...new Set(processedData.map((row) => row.strategy).filter(Boolean))].sort();

              setAllData(processedData);
              setAllStrategies(uniqueStrategies);
              setSelectedStrategies(uniqueStrategies);
              setSelectedLegType("All Trades");
              setIsNormalized(false);
            },
            error: (error) => {
              console.error("CSV parsing error:", error.message);
              setFileName("Error parsing file!");
              setAllData([]);
            },
          });
        };

        const filteredData = useMemo(() => {
          let data = allData.filter((row) => selectedStrategies.includes(row.strategy));

          if (selectedLegType === "Core (STO)") {
            data = data.filter((row) => row.legType === "Core (STO)");
          } else if (selectedLegType === "Wing (BTO)") {
            data = data.filter((row) => row.legType === "Wing (BTO)");
          }

          return data;
        }, [allData, selectedStrategies, selectedLegType]);

        const metrics = useMemo(() => calculateMetrics(filteredData, isNormalized), [filteredData, isNormalized]);
        const chartData = useMemo(() => prepareChartData(filteredData, isNormalized), [filteredData, isNormalized]);
        const hasReasonSlices = useMemo(
          () => chartData.reasonData.some(d => d.valueAbs > 0),
          [chartData.reasonData]
        );
        const PIE_COLORS = ["#0088FE", "#00C49F", "#FFBB28", "#FF8042", "#8884D8", "#FF00FF"];

        return (
          <div className="min-h-screen bg-gray-900 text-gray-200 font-sans p-4 md:p-8">
            <div className="max-w-7xl mx-auto">
              <header className="mb-8">
                <h1 className="text-4xl font-bold text-white mb-2">0DTE Strategy Dashboard</h1>
                <p className="text-lg text-gray-400">Upload your trade log to analyze live performance and risk.</p>
              </header>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div className="lg:col-span-1">
                  {parserReady ? (
                    <FileUploader onFileUpload={handleFileUpload} fileName={fileName} />
                  ) : (
                    <div className="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center bg-gray-800 text-gray-400 h-full flex flex-col justify-center">
                      <p className="text-xl font-semibold">Loading data parser...</p>
                      <p className="text-sm">Please wait.</p>
                    </div>
                  )}
                </div>
                {allData.length > 0 && (
                  <>
                    <div className="lg:col-span-1">
                      <StrategyFilter
                        allStrategies={allStrategies}
                        selectedStrategies={selectedStrategies}
                        onChange={setSelectedStrategies}
                      />
                    </div>
                    <div className="lg:col-span-1">
                      <LegTypeFilter selectedValue={selectedLegType} onChange={setSelectedLegType} />
                    </div>
                    <div className="lg:col-span-1">
                      <NormalizationToggle isNormalized={isNormalized} onChange={setIsNormalized} />
                    </div>
                  </>
                )}
              </div>

              {allData.length === 0 ? (
                <div className="text-center text-gray-500 bg-gray-800 p-12 rounded-lg">
                  <h2 className="text-2xl font-semibold">Waiting for data...</h2>
                  <p className="text-lg">Please upload your CSV file to populate the dashboard.</p>
                </div>
              ) : filteredData.length === 0 ? (
                <div className="text-center text-gray-500 bg-gray-800 p-12 rounded-lg">
                  <h2 className="text-2xl font-semibold">No Data for Selected Filters</h2>
                  <p className="text-lg">Try adjusting your 'Strategy' or 'Leg Type' filters.</p>
                </div>
              ) : (
                <>
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <KpiCard
                      title={isNormalized ? "Total P/L (Per Contract)" : "Total P/L"}
                      value={metrics.totalPL}
                      format="currency"
                      icon={Icons.DollarSign}
                    />
                    <KpiCard title="Profit Factor" value={metrics.profitFactor} format="decimal" icon={Icons.DivideCircle} />
                    <KpiCard title="Win Rate" value={metrics.winRate} format="percent" icon={Icons.CheckCircle} />
                    <KpiCard
                      title="Profit Capture %"
                      value={metrics.profitCapturePct}
                      format="percent"
                      icon={Icons.Waves}
                      unit={
                        selectedLegType === "Core (STO)" || selectedLegType === "All Trades"
                          ? "(STO Only)"
                          : ""
                      }
                    />

                    <KpiCard title="Avg. Win" value={metrics.avgWin} format="currency" icon={Icons.PlusCircle} />
                    <KpiCard title="Avg. Loss" value={metrics.avgLoss} format="currency" icon={Icons.MinusCircle} />
                    <KpiCard title="Avg. P/L Per Trade" value={metrics.avgPL} format="currency" icon={Icons.TrendingUp} />
                    <KpiCard title="Total Trades" value={metrics.totalTrades} icon={Icons.FileText} />

                    <KpiCard title="95% CVaR (Tail Risk)" value={metrics.cvar95} format="currency" icon={Icons.AlertTriangle} />
                    <KpiCard title="95% VaR" value={metrics.var95} format="currency" icon={Icons.TrendingDown} />
                    <div className="hidden lg:block" />
                    <div className="hidden lg:block" />
                  </div>

                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div className="bg-gray-800 p-6 rounded-xl shadow-lg h-96">
                      <h3 className="text-xl font-semibold text-white mb-4">
                        Cumulative P/L {isNormalized && "(Per Contract)"}
                      </h3>
                      <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={chartData.equityCurve} margin={{ top: 5, right: 20, left: 10, bottom: 20 }}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#4B5563" />
                          <XAxis
                            dataKey="tradeNumber"
                            stroke="#9CA3AF"
                            label={{ value: "Trade Number", position: "insideBottom", offset: -15, fill: "#9CA3AF" }}
                            domain={["dataMin", "dataMax"]}
                          />
                          <YAxis
                            stroke="#9CA3AF"
                            tickFormatter={(val) => `$${val.toLocaleString()}`}
                            domain={["auto", "auto"]}
                          />
                          <Tooltip
                            contentStyle={{ backgroundColor: "#1F2937", border: "1px solid #374151" }}
                            labelStyle={{ color: "#E5E7EB" }}
                            formatter={(value) => [
                              value.toLocaleString("en-US", {
                                style: "currency",
                                currency: "USD",
                                maximumFractionDigits: isNormalized ? 4 : 2,
                              }),
                              "Cumulative P/L",
                            ]}
                          />
                          <Legend wrapperStyle={{ color: "#E5E7EB" }} />
                          <Line type="monotone" dataKey="Cumulative P/L" stroke="#3B82F6" strokeWidth={2} dot={false} />
                        </LineChart>
                      </ResponsiveContainer>
                    </div>

                    <div className="bg-gray-800 p-6 rounded-xl shadow-lg h-96">
                      <h3 className="text-xl font-semibold text-white mb-4 flex items-center space-x-2">
                        <Icons.Clock size={20} />
                        <span>P/L by Open Hour {isNormalized && "(Per Contract)"}</span>
                      </h3>
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={chartData.hourlyPLData} margin={{ top: 5, right: 20, left: 10, bottom: 5 }}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#4B5563" />
                          <XAxis dataKey="hourLabel" stroke="#9CA3AF" tick={{ fontSize: 10 }} />
                          <YAxis stroke="#9CA3AF" tickFormatter={(val) => `$${val.toLocaleString()}`} />
                          <Tooltip
                            contentStyle={{ backgroundColor: "#1F2937", border: "1px solid #374151" }}
                            labelStyle={{ color: "#E5E7EB" }}
                            formatter={(value, name) => [
                              value.toLocaleString("en-US", {
                                style: "currency",
                                currency: "USD",
                                maximumFractionDigits: isNormalized ? 4 : 0,
                              }),
                              name,
                            ]}
                          />
                          <Legend wrapperStyle={{ color: "#E5E7EB" }} />
                          <Bar dataKey="Total P/L" name="Total P/L">
                            {chartData.hourlyPLData.map((entry, index) => (
                              <Cell key={`hour-cell-${index}`} fill={entry["Total P/L"] < 0 ? "#EF4444" : "#10B981"} />
                            ))}
                          </Bar>
                        </BarChart>
                      </ResponsiveContainer>
                    </div>

                    <div className="bg-gray-800 p-6 rounded-xl shadow-lg h-96">
                      <h3 className="text-xl font-semibold text-white mb-4 flex items-center space-x-2">
                        <Icons.CalendarDays size={20} />
                        <span>P/L by Day of Week {isNormalized && "(Per Contract)"}</span>
                      </h3>
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={chartData.dayOfWeekPLData} margin={{ top: 5, right: 20, left: 10, bottom: 5 }}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#4B5563" />
                          <XAxis dataKey="day" stroke="#9CA3AF" />
                          <YAxis stroke="#9CA3AF" tickFormatter={(val) => `$${val.toLocaleString()}`} />
                          <Tooltip
                            contentStyle={{ backgroundColor: "#1F2937", border: "1px solid #374151" }}
                            labelStyle={{ color: "#E5E7EB" }}
                            formatter={(value, name) => [
                              value.toLocaleString("en-US", {
                                style: "currency",
                                currency: "USD",
                                maximumFractionDigits: isNormalized ? 4 : 0,
                              }),
                              name,
                            ]}
                          />
                          <Legend wrapperStyle={{ color: "#E5E7EB" }} />
                          <Bar dataKey="Total P/L" name="Total P/L">
                            {chartData.dayOfWeekPLData.map((entry, index) => (
                              <Cell key={`day-cell-${index}`} fill={entry["Total P/L"] < 0 ? "#EF4444" : "#10B981"} />
                            ))}
                          </Bar>
                        </BarChart>
                      </ResponsiveContainer>
                    </div>

                    <div className="bg-gray-800 p-6 rounded-xl shadow-lg h-96">
                      <h3 className="text-xl font-semibold text-white mb-4 flex items-center space-x-2">
                        <Icons.Timer size={20} />
                        <span>P/L by Trade Duration {isNormalized && "(Per Contract)"}</span>
                      </h3>
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={chartData.durationPLData} margin={{ top: 5, right: 20, left: 10, bottom: 5 }}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#4B5563" />
                          <XAxis dataKey="label" stroke="#9CA3AF" />
                          <YAxis stroke="#9CA3AF" tickFormatter={(val) => `$${val.toLocaleString()}`} />
                          <Tooltip
                            contentStyle={{ backgroundColor: "#1F2937", border: "1px solid #374151" }}
                            labelStyle={{ color: "#E5E7EB" }}
                            formatter={(value, name) => [
                              value.toLocaleString("en-US", {
                                style: "currency",
                                currency: "USD",
                                maximumFractionDigits: isNormalized ? 4 : 0,
                              }),
                              name,
                            ]}
                          />
                          <Legend wrapperStyle={{ color: "#E5E7EB" }} />
                          <Bar dataKey="Total P/L" name="Total P/L">
                            {chartData.durationPLData.map((entry, index) => (
                              <Cell key={`duration-cell-${index}`} fill={entry["Total P/L"] < 0 ? "#EF4444" : "#10B981"} />
                            ))}
                          </Bar>
                        </BarChart>
                      </ResponsiveContainer>
                    </div>

                    <div className="bg-gray-800 p-6 rounded-xl shadow-lg h-96">
                      <h3 className="text-xl font-semibold text-white mb-4 flex items-center space-x-2">
                        <Icons.BarChartHorizontal size={20} />
                        <span>P/L by Underlying's Move {isNormalized && "(Per Contract)"}</span>
                      </h3>
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={chartData.underlyingMovePLData} margin={{ top: 5, right: 20, left: 10, bottom: 5 }}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#4B5563" />
                          <XAxis dataKey="label" stroke="#9CA3AF" tick={{ fontSize: 10 }} />
                          <YAxis stroke="#9CA3AF" tickFormatter={(val) => `$${val.toLocaleString()}`} />
                          <Tooltip
                            contentStyle={{ backgroundColor: "#1F2937", border: "1px solid #374151" }}
                            labelStyle={{ color: "#E5E7EB" }}
                            formatter={(value, name) => [
                              value.toLocaleString("en-US", {
                                style: "currency",
                                currency: "USD",
                                maximumFractionDigits: isNormalized ? 4 : 0,
                              }),
                              name,
                            ]}
                          />
                          <Legend wrapperStyle={{ color: "#E5E7EB" }} />
                          <Bar dataKey="Total P/L" name="Total P/L">
                            {chartData.underlyingMovePLData.map((entry, index) => (
                              <Cell key={`move-cell-${index}`} fill={entry["Total P/L"] < 0 ? "#EF4444" : "#10B981"} />
                            ))}
                          </Bar>
                        </BarChart>
                      </ResponsiveContainer>
                    </div>

                    <div className="bg-gray-800 p-6 rounded-xl shadow-lg h-96">
                      <h3 className="text-xl font-semibold text-white mb-4">
                        P/L Distribution {isNormalized && "(Per Contract)"}
                      </h3>
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={chartData.plDistribution} margin={{ top: 5, right: 20, left: 10, bottom: 20 }}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#4B5563" />
                          <XAxis
                            dataKey="range"
                            stroke="#9CA3AF"
                            tick={{ fontSize: 10 }}
                            label={{ value: "P/L Bins ($)", position: "insideBottom", offset: -15, fill: "#9CA3AF" }}
                          />
                          <YAxis stroke="#9CA3AF" allowDecimals={false} />
                          <Tooltip
                            contentStyle={{ backgroundColor: "#1F2937", border: "1px solid #374151" }}
                            labelStyle={{ color: "#E5E7EB" }}
                          />
                          <Legend wrapperStyle={{ color: "#E5E7EB" }} />
                          <Bar dataKey="count" fill="#10B981">
                            {chartData.plDistribution.map((entry, index) => (
                              <Cell key={`dist-cell-${index}`} fill={entry.binStart < 0 ? "#EF4444" : "#10B981"} />
                            ))}
                          </Bar>
                        </BarChart>
                      </ResponsiveContainer>
                    </div>

                    <div className="bg-gray-800 p-6 rounded-xl shadow-lg h-96 lg:col-span-2">
                      <h3 className="text-xl font-semibold text-white mb-4">
                        Total P/L by Close Reason {isNormalized && "(Per Contract)"}
                      </h3>
                    
                      {hasReasonSlices ? (
                        <ResponsiveContainer width="100%" height="100%">
                          <PieChart>
                            <Pie
                              data={chartData.reasonData}
                              dataKey="valueAbs"     // absolute for slice size
                              nameKey="name"
                              cx="50%"
                              cy="50%"
                              outerRadius={120}
                              labelLine={false}
                              label={({ name, percent, payload }) =>
                                `${name}: ${payload.value.toLocaleString("en-US", {
                                  style: "currency",
                                  currency: "USD",
                                  maximumFractionDigits: isNormalized ? 4 : 0,
                                })} (${Number.isFinite(percent) ? (percent * 100).toFixed(0) : "0"}%)`
                              }
                            >
                              {chartData.reasonData.map((entry, index) => (
                                <Cell
                                  key={`reason-cell-${index}`}
                                  fill={entry.sign >= 0 ? "#10B981" : "#EF4444"} // green for +, red for -
                                />
                              ))}
                            </Pie>
                            <Tooltip
                              formatter={(_, __, { payload }) =>
                                [
                                  payload.value.toLocaleString("en-US", {
                                    style: "currency",
                                    currency: "USD",
                                    maximumFractionDigits: isNormalized ? 4 : 2,
                                  }),
                                  payload.name,
                                ]
                              }
                              contentStyle={{ backgroundColor: "#1F2937", border: "1px solid #374151" }}
                            />
                            <Legend wrapperStyle={{ color: "#E5E7EB" }} />
                          </PieChart>
                        </ResponsiveContainer>
                      ) : (
                        <div className="h-full flex items-center justify-center text-gray-400">
                          No data to plot yet. All close reasons net to zero.
                        </div>
                      )}
                    </div>

                  </div>

                  <div className="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h3 className="text-xl font-semibold text-white mb-4">
                      Filtered Trade Log ({filteredData.length} Trades)
                    </h3>
                    <div className="overflow-auto max-h-96 relative">
                      <table className="min-w-full divide-y divide-gray-700">
                        <thead className="bg-gray-700 sticky top-0">
                          <tr>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Strategy</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Leg Type</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date Opened</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Hold (min)</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">P/L</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Contracts</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Premium</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Open Price</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Close Price</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Reason</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Legs</th>
                          </tr>
                        </thead>
                        <tbody className="bg-gray-800 divide-y divide-gray-700">
                          {filteredData.slice(0, 200).map((row, i) => (
                            <tr key={`${row.strategy}-${i}`} className="hover:bg-gray-700">
                              <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-200">{row.strategy}</td>
                              <td className="px-4 py-3 whitespace-nowrap text-sm">
                                <span
                                  className={`px-2 py-0.5 rounded-full text-xs font-medium ${
                                    row.legType === "Core (STO)"
                                      ? "bg-red-900 text-red-300"
                                      : row.legType === "Wing (BTO)"
                                      ? "bg-green-900 text-green-300"
                                      : "bg-gray-700 text-gray-300"
                                  }`}
                                >
                                  {row.legType}
                                </span>
                              </td>
                              <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-200">{row.dateOpened.toLocaleString()}</td>
                              <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-200">
                                {Number.isFinite(row.durationMinutes) ? row.durationMinutes.toFixed(1) : "--"}
                              </td>
                              <td
                                className={`px-4 py-3 whitespace-nowrap text-sm font-medium ${
                                  row.pl < 0 ? "text-red-400" : "text-green-400"
                                }`}
                              >
                                {Number.isFinite(row.pl) ? row.pl.toFixed(2) : "--"}
                              </td>
                              <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-200">{row.contracts}</td>
                              <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-200">
                                {Number.isFinite(row.initialPremium) ? row.initialPremium : "--"}
                              </td>
                              <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-200">
                                {Number.isFinite(row.openingPrice) ? row.openingPrice : "--"}
                              </td>
                              <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-200">
                                {Number.isFinite(row.closingPrice) ? row.closingPrice : "--"}
                              </td>
                              <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-200">{row.reason}</td>
                              <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-400 max-w-xs truncate">{row["Legs"]}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                      {filteredData.length > 200 && (
                        <div className="text-center p-4 font-medium text-gray-500">Showing first 200 trades.</div>
                      )}
                    </div>
                  </div>
                </>
              )}
            </div>
          </div>
        );
      };

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
      })();
    </script>
  </body>
</html>
